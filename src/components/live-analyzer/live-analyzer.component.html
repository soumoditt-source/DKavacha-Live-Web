<div class="relative w-full transition-all duration-300" [class.max-w-5xl]="!overlayMode" [class.mx-auto]="!overlayMode">
  
  <!-- Overlay Mode Container Injection -->
  <div [class.overlay-mode]="overlayMode" [class.glass-panel]="overlayMode" [class.border-cyan-500]="overlayMode">
      
      <!-- Main Content Area -->
      <div [class.grid]="!overlayMode" [class.grid-cols-1]="!overlayMode" [class.md:grid-cols-3]="!overlayMode" [class.gap-6]="!overlayMode">
  
          <!-- Left Panel: Visualizer & Controls -->
          <div [class.md:col-span-2]="!overlayMode" class="space-y-6">
              
              <!-- Main Panel -->
              <div class="glass-panel rounded-xl p-6 md:p-8 relative z-10 overflow-hidden" 
                   [class.min-h-[400px]]="!overlayMode"
                   [class.p-4]="overlayMode">
                
                <!-- Background Scanline -->
                <div class="absolute inset-0 z-0 pointer-events-none overflow-hidden rounded-xl">
                    <div class="scanline"></div>
                </div>

                <!-- Header -->
                <div class="flex justify-between items-center mb-4">
                  <div class="flex items-center gap-3">
                    <div class="w-3 h-3 rounded-full animate-pulse"
                         [class.bg-red-500]="audioService.isRecording()"
                         [class.bg-gray-600]="!audioService.isRecording()">
                    </div>
                    <div>
                        <h2 class="font-cyber text-white tracking-widest" [class.text-xl]="!overlayMode" [class.text-sm]="overlayMode">
                          LIVE GUARDIAN
                        </h2>
                        <div class="text-[10px] text-cyan-500/80 font-mono" *ngIf="fraudService.currentSession() as session">
                            SID: {{ session.id }}
                        </div>
                    </div>
                  </div>
                  
                  <!-- Compact Controls for Overlay -->
                  <div class="flex gap-2">
                     <button (click)="toggleOverlay()" class="p-1 hover:text-cyan-400 text-gray-400 transition" title="Toggle Overlay/Window Mode">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                        </svg>
                     </button>
                  </div>
                </div>

                <!-- Main Visualizer Area -->
                <div class="bg-black/40 rounded-lg border border-white/5 flex items-end justify-between px-4 py-2 gap-1 mb-6 relative"
                     [class.h-48]="!overlayMode" [class.md:h-64]="!overlayMode" [class.h-20]="overlayMode">
                  
                  <!-- Safe/Fraud Overlay Indicator -->
                  @if (audioService.isRecording()) {
                    <div class="absolute top-2 right-2 px-2 py-0.5 rounded border backdrop-blur-md transition-colors duration-300 z-20 shadow-lg"
                         [class.border-red-500]="fraudAlert()"
                         [class.bg-red-900/80]="fraudAlert()"
                         [class.border-emerald-500]="!fraudAlert()"
                         [class.bg-emerald-900/60]="!fraudAlert()">
                      <span class="font-mono font-bold tracking-wider text-xs"
                            [class.text-white]="fraudAlert()"
                            [class.text-emerald-300]="!fraudAlert()">
                        {{ fraudAlert() ? 'THREAT DETECTED' : 'SECURE' }}
                      </span>
                    </div>
                  }

                  <!-- Visualizer Bars -->
                  @for (height of visualizerBars(); track $index) {
                    <div class="bar w-full rounded-t-sm"
                         [style.height.%]="height"
                         [class.bg-cyan-500]="!fraudAlert()"
                         [class.bg-red-500]="fraudAlert()"
                         [class.shadow-[0_0_10px_rgba(0,255,255,0.5)]]="!fraudAlert()"
                         [class.shadow-[0_0_15px_rgba(255,0,0,0.6)]]="fraudAlert()">
                    </div>
                  }
                </div>

                <!-- Primary Controls -->
                <div class="flex items-center gap-4" *ngIf="!overlayMode">
                    <button (click)="toggleSession()"
                            class="flex-1 py-4 font-cyber font-bold tracking-widest text-lg rounded bg-gradient-to-r transition-all duration-300 transform hover:scale-[1.01] active:scale-[0.99] border border-white/10"
                            [class.from-cyan-900]="!audioService.isRecording()"
                            [class.to-blue-900]="!audioService.isRecording()"
                            [class.from-red-900]="audioService.isRecording()"
                            [class.to-rose-900]="audioService.isRecording()"
                            [class.text-gray-200]="true">
                      {{ audioService.isRecording() ? 'TERMINATE UPLINK' : 'INITIALIZE UPLINK' }}
                    </button>
                    
                    <button (click)="toggleVoice()" 
                            class="px-4 py-4 rounded border border-white/10 transition-colors bg-white/5 hover:bg-white/10"
                            [class.text-cyan-400]="audioService.voiceEnabled()"
                            [class.text-gray-500]="!audioService.voiceEnabled()"
                            title="AI Voice Sentinel">
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] font-mono mb-1">AI VOICE</span>
                            <div class="w-3 h-3 rounded-full" [class.bg-cyan-500]="audioService.voiceEnabled()" [class.bg-gray-600]="!audioService.voiceEnabled()"></div>
                        </div>
                    </button>

                    <button (click)="toggleHaptics()" 
                            class="px-4 py-4 rounded border border-white/10 transition-colors bg-white/5 hover:bg-white/10"
                            [class.text-orange-400]="fraudService.hapticEnabled()"
                            [class.text-gray-500]="!fraudService.hapticEnabled()"
                            title="Haptic Feedback">
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] font-mono mb-1">HAPTICS</span>
                            <div class="w-3 h-3 rounded-full" [class.bg-orange-500]="fraudService.hapticEnabled()" [class.bg-gray-600]="!fraudService.hapticEnabled()"></div>
                        </div>
                    </button>
                </div>
              </div>
          </div>

          <!-- Right Panel: Forensics (Hidden in Overlay Mode) -->
          <div class="md:col-span-1 flex flex-col gap-6" *ngIf="!overlayMode">
              
              <!-- Metrics Cards -->
              <div class="grid grid-cols-2 gap-4">
                <div class="glass-panel p-3 rounded-lg border-l-2 border-cyan-500">
                    <div class="text-[10px] text-gray-400 font-mono mb-1">PROBABILITY</div>
                    <div class="text-xl font-cyber text-white">
                      {{ (fraudService.currentResult()?.probability || 0) | percent:'1.0-0' }}
                    </div>
                </div>
                <div class="glass-panel p-3 rounded-lg border-l-2"
                     [class.border-red-500]="fraudAlert()" 
                     [class.border-emerald-500]="!fraudAlert()">
                    <div class="text-[10px] text-gray-400 font-mono mb-1">RECOMMENDATION</div>
                    <div class="text-sm font-bold font-mono truncate"
                         [class.text-red-400]="fraudAlert()"
                         [class.text-emerald-400]="!fraudAlert()">
                       {{ (fraudService.currentResult()?.actionRecommendation) || 'IDLE' }}
                    </div>
                </div>
              </div>

              <!-- Live Transcript Terminal -->
              <div class="glass-panel flex-1 rounded-xl p-4 flex flex-col overflow-hidden relative border border-cyan-500/20">
                  <div class="absolute top-0 left-0 w-full bg-cyan-900/20 p-2 text-[10px] font-mono text-cyan-400 border-b border-cyan-500/20 backdrop-blur-sm z-10 flex justify-between">
                      <span>> LIVE TRANSCRIPT_</span>
                      <span class="text-cyan-600">{{ audioService.voiceEnabled() ? 'VOICE GUARD ACTIVE' : 'SILENT MODE' }}</span>
                  </div>
                  <div #scrollContainer class="transcript-box mt-8 flex-1 overflow-y-auto font-mono text-xs md:text-sm text-cyan-100/80 space-y-2 max-h-[300px]">
                      @if (audioService.transcript()) {
                          <p class="break-words leading-relaxed">
                              {{ audioService.transcript() }}
                              <span class="inline-block w-2 h-4 bg-cyan-500 align-middle animate-pulse"></span>
                          </p>
                      } @else {
                          <div class="h-full flex items-center justify-center text-gray-600 italic">
                              Waiting for audio input...
                          </div>
                      }
                  </div>
              </div>

              <!-- Detected Phrases Alerts -->
              @if (keywordsDetected()) {
                  <div class="glass-panel p-3 rounded-xl border border-red-500/50 bg-red-900/10">
                      <div class="text-[10px] font-bold text-red-400 mb-2 uppercase tracking-wider flex items-center gap-2">
                          <span class="w-2 h-2 rounded-full bg-red-500 animate-ping"></span>
                          FORENSIC ALERTS
                      </div>
                      <div class="flex flex-wrap gap-2">
                          @for (phrase of uniqueKeywords(); track $index) {
                              <span class="px-2 py-1 bg-red-500/20 border border-red-500/30 rounded text-[10px] text-red-200 font-mono">
                                  {{ phrase }}
                              </span>
                          }
                      </div>
                      <div class="mt-2 text-[10px] text-red-300/60 leading-tight">
                          Automated Advisory Sent to User.
                      </div>
                  </div>
              }
          </div>
      </div>
  </div>
</div>

<!-- Fullscreen Fraud Warning Overlay -->
@if (fraudAlert()) {
  <div class="fixed inset-0 z-[100] pointer-events-none flex flex-col items-center justify-center bg-red-950/80 backdrop-blur-sm">
    <div class="absolute inset-0 border-[40px] border-red-600/20 animate-pulse"></div>
    <h1 class="font-cyber text-6xl md:text-9xl text-red-500 font-black animate-pulse select-none filter drop-shadow-[0_0_30px_rgba(220,38,38,0.8)] text-center">
      FRAUD<br>DETECTED
    </h1>
    <div class="text-red-200 font-mono text-xl mt-4 bg-black/50 px-6 py-3 rounded border border-red-500/50 animate-bounce">
        {{ fraudService.currentResult()?.actionRecommendation }}
    </div>
  </div>
}