
<div class="relative w-full transition-all duration-300" 
     [class.max-w-5xl]="!overlayMode" 
     [class.mx-auto]="!overlayMode"
     [class.animate-pulse]="fraudAlert()" 
     [class.bg-red-950_30]="fraudAlert()">
  
  <!-- Overlay Mode Container Injection -->
  <div [class.overlay-mode]="overlayMode" [class.glass-panel]="overlayMode" [class.border-cyan-500]="overlayMode">
      
      <!-- Main Content Area -->
      <div [class.grid]="!overlayMode" [class.grid-cols-1]="!overlayMode" [class.md:grid-cols-3]="!overlayMode" [class.gap-6]="!overlayMode">
  
          <!-- Left Panel: Visualizer & Controls -->
          <div [class.md:col-span-2]="!overlayMode" class="space-y-6">
              
              <!-- Main Panel -->
              <div class="glass-panel rounded-xl p-6 md:p-8 relative z-10 overflow-hidden border transition-colors duration-300" 
                   [class.min-h-[400px]]="!overlayMode"
                   [class.p-4]="overlayMode"
                   [class.border-red-500]="fraudAlert()"
                   [class.shadow-[0_0_50px_rgba(220,38,38,0.3)]]="fraudAlert()">
                
                <!-- Background Scanline -->
                <div class="absolute inset-0 z-0 pointer-events-none overflow-hidden rounded-xl">
                    <div class="scanline"></div>
                </div>

                <!-- Header -->
                <div class="flex justify-between items-center mb-4">
                  <div class="flex items-center gap-3">
                    <div class="w-3 h-3 rounded-full animate-pulse"
                         [class.bg-red-500]="audioService.isRecording()"
                         [class.bg-gray-600]="!audioService.isRecording()">
                    </div>
                    <div>
                        <h2 class="font-cyber tracking-widest transition-colors" 
                            [class.text-xl]="!overlayMode" 
                            [class.text-sm]="overlayMode"
                            [class.text-red-500]="fraudAlert()"
                            [class.text-white]="!fraudAlert()">
                          {{ fraudAlert() ? 'THREAT DETECTED' : 'LIVE GUARDIAN' }}
                        </h2>
                        <div class="text-[10px] text-cyan-500/80 font-mono" *ngIf="fraudService.currentSession() as session">
                            SID: {{ session.id }}
                        </div>
                    </div>
                  </div>
                  
                  <!-- Compact Controls for Overlay -->
                  <div class="flex gap-2">
                     <button (click)="toggleOverlay()" class="p-1 hover:text-cyan-400 text-gray-400 transition" title="Toggle Overlay/Window Mode">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                        </svg>
                     </button>
                     <button (click)="toggleSettings()" class="p-1 hover:text-cyan-400 text-gray-400 transition" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                     </button>
                  </div>
                </div>

                <!-- Main Visualizer Area -->
                <div class="bg-black/40 rounded-lg border border-white/5 flex items-end justify-between px-4 py-2 gap-1 mb-6 relative"
                     [class.h-48]="!overlayMode" [class.md:h-64]="!overlayMode" [class.h-20]="overlayMode">
                  
                  <!-- Safe/Fraud Overlay Indicator -->
                  @if (audioService.isRecording()) {
                    <div class="absolute top-2 right-2 px-2 py-0.5 rounded border backdrop-blur-md transition-colors duration-300 z-20 shadow-lg"
                         [class.border-red-500]="fraudAlert()"
                         [class.bg-red-900/80]="fraudAlert()"
                         [class.border-emerald-500]="!fraudAlert()"
                         [class.bg-emerald-900/60]="!fraudAlert()">
                      <span class="font-mono font-bold tracking-wider text-xs"
                            [class.text-white]="fraudAlert()"
                            [class.text-emerald-300]="!fraudAlert()">
                        {{ fraudAlert() ? 'THREAT DETECTED' : 'SECURE' }}
                      </span>
                    </div>
                  }

                  <!-- Visualizer Bars -->
                  @for (height of visualizerBars(); track $index) {
                    <div class="bar w-full rounded-t-sm"
                         [style.height.%]="height"
                         [class.bg-cyan-500]="!fraudAlert()"
                         [class.bg-red-500]="fraudAlert()"
                         [class.shadow-[0_0_10px_rgba(0,255,255,0.5)]]="!fraudAlert()"
                         [class.shadow-[0_0_15px_rgba(255,0,0,0.6)]]="fraudAlert()">
                    </div>
                  }
                </div>

                <!-- Primary Controls -->
                <div class="flex items-center gap-4" *ngIf="!overlayMode">
                    <button (click)="toggleSession()"
                            class="flex-1 py-4 font-cyber font-bold tracking-widest text-lg rounded bg-gradient-to-r transition-all duration-300 transform hover:scale-[1.01] active:scale-[0.99] border border-white/10"
                            [class.from-cyan-900]="!audioService.isRecording()"
                            [class.to-blue-900]="!audioService.isRecording()"
                            [class.from-red-900]="audioService.isRecording()"
                            [class.to-rose-900]="audioService.isRecording()"
                            [class.text-gray-200]="true">
                      {{ audioService.isRecording() ? 'TERMINATE UPLINK' : 'INITIALIZE UPLINK' }}
                    </button>
                    
                    <button (click)="toggleVoice()" 
                            class="px-4 py-4 rounded border border-white/10 transition-colors bg-white/5 hover:bg-white/10 relative group"
                            [class.text-cyan-400]="audioService.voiceEnabled()"
                            [class.text-gray-500]="!audioService.voiceEnabled()"
                            title="AI Voice Sentinel (Use Headphones)">
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] font-mono mb-1">AI VOICE</span>
                            <div class="w-3 h-3 rounded-full" [class.bg-cyan-500]="audioService.voiceEnabled()" [class.bg-gray-600]="!audioService.voiceEnabled()"></div>
                        </div>
                    </button>
                </div>
              </div>
          </div>

          <!-- Right Panel: Forensics (Hidden in Overlay Mode) -->
          <div class="md:col-span-1 flex flex-col gap-6" *ngIf="!overlayMode">
              
              <!-- Metrics Cards -->
              <div class="grid grid-cols-2 gap-4">
                <div class="glass-panel p-3 rounded-lg border-l-2 border-cyan-500">
                    <div class="text-[10px] text-gray-400 font-mono mb-1">PROBABILITY</div>
                    <div class="text-xl font-cyber text-white">
                      {{ (fraudService.currentResult()?.probability || 0) | percent:'1.0-0' }}
                    </div>
                </div>
                <div class="glass-panel p-3 rounded-lg border-l-2"
                     [class.border-red-500]="fraudAlert()" 
                     [class.border-emerald-500]="!fraudAlert()">
                    <div class="text-[10px] text-gray-400 font-mono mb-1">RECOMMENDATION</div>
                    <div class="text-sm font-bold font-mono truncate"
                         [class.text-red-400]="fraudAlert()"
                         [class.text-emerald-400]="!fraudAlert()">
                       {{ (fraudService.currentResult()?.actionRecommendation) || 'IDLE' }}
                    </div>
                </div>
              </div>

              <!-- Live Transcript Terminal -->
              <div class="glass-panel flex-1 rounded-xl p-4 flex flex-col overflow-hidden relative border border-cyan-500/20">
                  <div class="absolute top-0 left-0 w-full bg-cyan-900/20 p-2 text-[10px] font-mono text-cyan-400 border-b border-cyan-500/20 backdrop-blur-sm z-10 flex justify-between">
                      <span>> LIVE TRANSCRIPT_</span>
                      <span class="text-cyan-600">{{ audioService.voiceEnabled() ? 'VOICE GUARD ACTIVE' : 'SILENT MODE' }}</span>
                  </div>
                  <div #scrollContainer class="transcript-box mt-8 flex-1 overflow-y-auto font-mono text-xs md:text-sm text-cyan-100/80 space-y-2 max-h-[300px]">
                      @if (audioService.transcript()) {
                          <p class="break-words leading-relaxed">
                              {{ audioService.transcript() }}
                              <span class="inline-block w-2 h-4 bg-cyan-500 align-middle animate-pulse"></span>
                          </p>
                      } @else {
                          <div class="h-full flex items-center justify-center text-gray-600 italic">
                              Waiting for audio input...
                          </div>
                      }
                  </div>
              </div>

              <!-- Detected Phrases Alerts -->
              @if (keywordsDetected()) {
                  <div class="glass-panel p-3 rounded-xl border border-red-500/50 bg-red-900/10">
                      <div class="text-[10px] font-bold text-red-400 mb-2 uppercase tracking-wider flex items-center gap-2">
                          <span class="w-2 h-2 rounded-full bg-red-500 animate-ping"></span>
                          FORENSIC ALERTS
                      </div>
                      <div class="flex flex-wrap gap-2">
                          @for (phrase of uniqueKeywords(); track $index) {
                              <span class="px-2 py-1 bg-red-500/20 border border-red-500/30 rounded text-[10px] text-red-200 font-mono">
                                  {{ phrase }}
                              </span>
                          }
                      </div>
                      <div class="mt-2 text-[10px] text-red-300/60 leading-tight">
                          Automated Advisory Sent to User.
                      </div>
                  </div>
              }
          </div>
      </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
@if (showSettings) {
    <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
        <div class="bg-slate-900/95 border border-cyan-500/30 p-6 rounded-xl w-full max-w-sm shadow-[0_0_50px_rgba(0,0,0,0.8)] relative">
            <button (click)="toggleSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-white">✕</button>
            <h3 class="font-cyber text-xl text-cyan-400 mb-6 flex items-center gap-2">
                <span>⚙</span> SENTINEL CONFIG
            </h3>
            
            <div class="space-y-6">
                <!-- Toggle Notification Master -->
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-sm text-white font-mono block">SYSTEM NOTIFICATIONS</span>
                        <span class="text-[10px] text-gray-500 block">Allow popup alerts</span>
                    </div>
                    <button (click)="updatePref('enabled', !prefs().enabled)" 
                            class="w-12 h-6 rounded-full transition-colors relative focus:outline-none"
                            [class.bg-emerald-600]="prefs().enabled"
                            [class.bg-gray-700]="!prefs().enabled">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-all shadow-md"
                             [class.left-7]="prefs().enabled"
                             [class.left-1]="!prefs().enabled"></div>
                    </button>
                </div>

                <!-- Toggle Sound -->
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-sm text-white font-mono block">VOICE & SOUND</span>
                        <span class="text-[10px] text-gray-500 block">AI Voice + Siren</span>
                    </div>
                    <button (click)="updatePref('soundEnabled', !prefs().soundEnabled)" 
                            class="w-12 h-6 rounded-full transition-colors relative focus:outline-none"
                            [class.bg-cyan-600]="prefs().soundEnabled"
                            [class.bg-gray-700]="!prefs().soundEnabled">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-all shadow-md"
                             [class.left-7]="prefs().soundEnabled"
                             [class.left-1]="!prefs().soundEnabled"></div>
                    </button>
                </div>

                <!-- Toggle Haptics -->
                <div class="flex items-center justify-between">
                    <div>
                         <span class="text-sm text-white font-mono block">HAPTIC FEEDBACK</span>
                         <span class="text-[10px] text-gray-500 block">Vibration on Threat</span>
                    </div>
                    <button (click)="updatePref('hapticsEnabled', !prefs().hapticsEnabled)" 
                            class="w-12 h-6 rounded-full transition-colors relative focus:outline-none"
                            [class.bg-purple-600]="prefs().hapticsEnabled"
                            [class.bg-gray-700]="!prefs().hapticsEnabled">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-all shadow-md"
                             [class.left-7]="prefs().hapticsEnabled"
                             [class.left-1]="!prefs().hapticsEnabled"></div>
                    </button>
                </div>

                <!-- Threshold -->
                <div class="pt-4 border-t border-white/10">
                    <label class="block text-[10px] font-mono text-gray-500 mb-3">DETECTION SENSITIVITY</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button *ngFor="let level of ['LOW','MEDIUM','HIGH']" 
                                (click)="updatePref('minThreshold', level)"
                                class="text-xs py-2 rounded border transition-colors font-mono hover:bg-white/5"
                                [class.bg-cyan-900_50]="prefs().minThreshold === level"
                                [class.border-cyan-500]="prefs().minThreshold === level"
                                [class.text-cyan-300]="prefs().minThreshold === level"
                                [class.border-white_10]="prefs().minThreshold !== level"
                                [class.text-gray-500]="prefs().minThreshold !== level">
                            {{ level }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- PERSISTENT CRITICAL ALERT OVERLAY (Mobile Optimized) -->
@if (criticalAlert(); as alert) {
  <div class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-red-950/95 backdrop-blur-xl animate-in zoom-in-95 duration-200 p-6 text-center">
    
    <!-- Pulse Effect -->
    <div class="absolute inset-0 border-[16px] border-red-600 animate-pulse pointer-events-none"></div>

    <div class="relative z-10 flex flex-col items-center max-w-md w-full">
        <div class="w-24 h-24 bg-red-600 rounded-full flex items-center justify-center mb-6 animate-bounce shadow-[0_0_50px_rgba(220,38,38,0.8)] border-4 border-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        </div>

        <h1 class="font-cyber text-5xl font-bold text-white mb-2 tracking-widest drop-shadow-[0_0_10px_rgba(255,0,0,0.8)]">{{ alert.title }}</h1>
        <p class="text-red-100 font-mono text-xl mb-8 bg-black/50 px-6 py-4 rounded-xl border border-red-500/50 shadow-xl">
            {{ alert.message }}
        </p>
        
        <div class="grid grid-cols-1 w-full gap-4">
            <!-- Action: Hang Up -->
            <button (click)="terminateCall()" 
                    class="w-full py-6 bg-red-600 hover:bg-red-500 rounded-xl text-white font-cyber font-bold text-2xl tracking-widest shadow-2xl active:scale-95 transition-transform flex items-center justify-center gap-3 border-2 border-red-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z" />
                </svg>
                HANG UP NOW
            </button>
            
            <!-- Action: Ignore -->
            <button (click)="dismissAlert()" 
                    class="w-full py-4 bg-transparent border border-white/20 rounded-xl text-gray-400 font-mono font-bold text-sm hover:bg-white/5 transition-colors">
                FALSE ALARM (DISMISS)
            </button>
        </div>
    </div>
  </div>
}
